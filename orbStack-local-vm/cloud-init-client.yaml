#cloud-config

# Cloud-init configuration for Nomad client VMs
# This script runs inside the VM during first boot

package_update: true
package_upgrade: false

packages:
  - wget
  - unzip
  - curl
  - docker.io

write_files:
  - path: /etc/nomad.d/client.hcl
    permissions: '0644'
    owner: root:root
    content: |
      data_dir = "/opt/nomad/data"
      
      log_level = "INFO"

      client {
        enabled = true
        servers = ["server-vm-0.orb.local:4647", "server-vm-1.orb.local:4647", "server-vm-2.orb.local:4647"]

        # Automatic server discovery
        server_join {
          retry_join = ["server-vm-0.orb.local", "server-vm-1.orb.local", "server-vm-2.orb.local"]
          retry_max = 30
          retry_interval = "5s"
        }
      }

  - path: /etc/systemd/system/nomad.service
    permissions: '0644'
    owner: root:root
    content: |
      [Unit]
      Description=Nomad Client
      Documentation=https://nomadproject.io/docs/
      Wants=network-online.target
      After=network-online.target

      [Service]
      ExecReload=/bin/kill -HUP $MAINPID
      ExecStart=/usr/local/bin/nomad agent -config /etc/nomad.d
      KillMode=process
      KillSignal=SIGINT
      LimitNOFILE=infinity
      LimitNPROC=infinity
      Restart=on-failure
      RestartSec=2
      TasksMax=infinity

      [Install]
      WantedBy=multi-user.target

runcmd:
  - mkdir -p /etc/nomad.d
  - mkdir -p /opt/nomad/data
  # Docker setup - start before Nomad
  - systemctl start docker
  - systemctl enable docker
  - sleep 5
  - usermod -aG docker nomad
  - systemctl restart docker
  # Nomad installation
  - cd /tmp
  - wget -q https://releases.hashicorp.com/nomad/1.7.3/nomad_1.7.3_linux_arm64.zip
  - unzip -q nomad_1.7.3_linux_arm64.zip
  - mv nomad /usr/local/bin/
  - chmod +x /usr/local/bin/nomad
  - rm -f nomad_1.7.3_linux_arm64.zip
  - systemctl daemon-reload
  - systemctl enable nomad
  - sleep 10
  - systemctl start nomad

final_message: "Nomad client setup completed after $UPTIME seconds"

#cloud-config

# Cloud-init configuration for Nomad server VMs
# This script runs inside the VM during first boot

package_update: true
package_upgrade: false

packages:
  - wget
  - unzip
  - curl

write_files:
  - path: /etc/nomad.d/server.hcl
    permissions: '0644'
    owner: root:root
    content: |
      data_dir = "/opt/nomad/data"

      # Enable logging for debugging
      log_level = "INFO"

      server {
        enabled = true
        bootstrap_expect = 3

        # Automatic clustering with aggressive retry settings
        server_join {
          retry_join = ["server-vm-0.orb.local:4648", "server-vm-1.orb.local:4648", "server-vm-2.orb.local:4648"]
          retry_max = 30
          retry_interval = "5s"
        }
      }

      # Bind to all interfaces
      bind_addr = "0.0.0.0"

      # Advertise the actual IP
      advertise {
        http = "{{ GetPrivateIP }}"
        rpc  = "{{ GetPrivateIP }}"
        serf = "{{ GetPrivateIP }}"
      }

      # UI configuration
      ui {
        enabled = true
      }

  - path: /etc/systemd/system/nomad.service
    permissions: '0644'
    owner: root:root
    content: |
      [Unit]
      Description=Nomad Server
      Documentation=https://nomadproject.io/docs/
      Wants=network-online.target
      After=network-online.target

      [Service]
      ExecReload=/bin/kill -HUP $MAINPID
      ExecStart=/usr/local/bin/nomad agent -config /etc/nomad.d
      KillMode=process
      KillSignal=SIGINT
      LimitNOFILE=infinity
      LimitNPROC=infinity
      Restart=on-failure
      RestartSec=2
      TasksMax=infinity

      [Install]
      WantedBy=multi-user.target

runcmd:
  - mkdir -p /etc/nomad.d
  - mkdir -p /opt/nomad/data
  - cd /tmp
  - wget -q https://releases.hashicorp.com/nomad/1.7.3/nomad_1.7.3_linux_arm64.zip
  - unzip -q nomad_1.7.3_linux_arm64.zip
  - mv nomad /usr/local/bin/
  - chmod +x /usr/local/bin/nomad
  - rm -f nomad_1.7.3_linux_arm64.zip
  - systemctl daemon-reload
  - systemctl enable nomad
  - systemctl start nomad

final_message: "Nomad server setup completed after $UPTIME seconds"

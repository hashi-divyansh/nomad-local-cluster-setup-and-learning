#cloud-config

# Cloud-init configuration for Consul + Nomad client VMs
# This script runs inside the VM during first boot

package_update: true
package_upgrade: false

packages:
  - wget
  - unzip
  - curl
  - docker.io
  - dnsmasq

write_files:
  # Consul Client Configuration
  - path: /etc/consul.d/client.hcl
    permissions: '0644'
    owner: root:root
    content: |
      datacenter = "dc1"
      data_dir = "/opt/consul/data"
      log_level = "INFO"
      
      server = false
      
      bind_addr = "{{ GetPrivateIP }}"
      client_addr = "0.0.0.0"
      
      retry_join = ["server-vm-0.orb.local", "server-vm-1.orb.local", "server-vm-2.orb.local"]
      
      connect {
        enabled = true
      }
      
      ports {
        grpc = 8502
      }

  - path: /etc/systemd/system/consul.service
    permissions: '0644'
    owner: root:root
    content: |
      [Unit]
      Description=Consul Client
      Documentation=https://www.consul.io/docs/
      Wants=network-online.target
      After=network-online.target

      [Service]
      ExecReload=/bin/kill -HUP $MAINPID
      ExecStart=/usr/local/bin/consul agent -config-dir=/etc/consul.d/
      KillMode=process
      KillSignal=SIGINT
      LimitNOFILE=infinity
      LimitNPROC=infinity
      Restart=on-failure
      RestartSec=2

      [Install]
      WantedBy=multi-user.target

  # Nomad Client Configuration with Consul integration
  - path: /etc/nomad.d/client.hcl
    permissions: '0644'
    owner: root:root
    content: |
      data_dir = "/opt/nomad/data"
      log_level = "INFO"

      client {
        enabled = true
        servers = ["server-vm-0.orb.local:4647", "server-vm-1.orb.local:4647", "server-vm-2.orb.local:4647"]

        server_join {
          retry_join = ["server-vm-0.orb.local", "server-vm-1.orb.local", "server-vm-2.orb.local"]
          retry_max = 30
          retry_interval = "5s"
        }
      }

      # Consul integration
      consul {
        address = "127.0.0.1:8500"
        auto_advertise = true
      }

  - path: /etc/systemd/system/nomad.service
    permissions: '0644'
    owner: root:root
    content: |
      [Unit]
      Description=Nomad Client
      Documentation=https://nomadproject.io/docs/
      Wants=network-online.target consul.service
      After=network-online.target consul.service

      [Service]
      ExecReload=/bin/kill -HUP $MAINPID
      ExecStart=/usr/local/bin/nomad agent -config /etc/nomad.d
      KillMode=process
      KillSignal=SIGINT
      LimitNOFILE=infinity
      LimitNPROC=infinity
      Restart=on-failure
      RestartSec=2
      TasksMax=infinity

      [Install]
      WantedBy=multi-user.target

  # DNSMasq configuration to resolve .consul domains
  - path: /etc/dnsmasq.d/10-consul
    permissions: '0644'
    owner: root:root
    content: |
      server=/consul/127.0.0.1#8600

runcmd:
  # Install Consul
  - mkdir -p /etc/consul.d
  - mkdir -p /opt/consul/data
  - cd /tmp
  - wget -q https://releases.hashicorp.com/consul/1.17.0/consul_1.17.0_linux_arm64.zip
  - unzip -q consul_1.17.0_linux_arm64.zip
  - mv consul /usr/local/bin/
  - chmod +x /usr/local/bin/consul
  - rm -f consul_1.17.0_linux_arm64.zip
  # Start Consul first
  - systemctl daemon-reload
  - systemctl enable consul
  - systemctl start consul
  - sleep 10
  # Docker setup
  - systemctl start docker
  - systemctl enable docker
  - sleep 5
  - usermod -aG docker nomad
  - systemctl restart docker
  # Install Nomad
  - mkdir -p /etc/nomad.d
  - mkdir -p /opt/nomad/data
  - cd /tmp
  - wget -q https://releases.hashicorp.com/nomad/1.7.3/nomad_1.7.3_linux_arm64.zip
  - unzip -q nomad_1.7.3_linux_arm64.zip
  - mv nomad /usr/local/bin/
  - chmod +x /usr/local/bin/nomad
  - rm -f nomad_1.7.3_linux_arm64.zip
  # Start Nomad after Consul
  - systemctl enable nomad
  - sleep 10
  - systemctl start nomad
  # Configure DNS
  - systemctl enable dnsmasq
  - systemctl restart dnsmasq

final_message: "Consul + Nomad client setup completed after $UPTIME seconds"
